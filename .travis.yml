language: bash
dist: bionic
env:
  global:
    - QEMU_VERSION="4.1.0"
    - GO_VERSION="1.12"
cache:
  directories:
    - $HOME/.cache/go-build
    - $HOME/gopath/pkg/mod
install:
  - sudo apt-get -yq --no-install-suggests --no-install-recommends install qemu-utils make curl telnet cpu-checker ninja-build
  - sudo modprobe kvm-intel nested=1
  - sudo chown $USER /dev/kvm
  - kvm-ok
  - free
  - lscpu
  - eval "$(curl -sL https://raw.githubusercontent.com/travis-ci/gimme/master/gimme | GIMME_GO_VERSION=$GO_VERSION bash)"
  - go version
  - sudo apt-get -yq build-dep qemu
  - wget https://download.qemu.org/qemu-$QEMU_VERSION.tar.xz
  - tar xvJf qemu-$QEMU_VERSION.tar.xz
  - cd qemu-$QEMU_VERSION
  - ./configure --target-list=x86_64-softmmu
  - make -j2
  - sudo make install
  - cd ..
  - qemu-system-x86_64 --version
script:
  - docker pull itmoeve/eden-http-server:1.2
  - docker tag itmoeve/eden-http-server:1.2 lfedge/eden-http-server:1.2
  - git clone https://github.com/lf-edge/eden.git --single-branch
  - cd eden
  - make build-tests
  - echo > tests/workflow/testdata/eden_stop.txt
  - ./eden test tests/workflow -v debug
after_script:
  - ./eden log --format=json